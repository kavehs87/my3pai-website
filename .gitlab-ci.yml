stages: [test, build, deploy]

default:
  tags: [docker]
  image:
    name: node:20-alpine
    pull_policy: if-not-present   # ← don’t re-pull if already cached on runner
  variables:
    NPM_CONFIG_CACHE: .npm        # optional: speed up npm
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
  before_script:
    - corepack enable
    - if [ -f package-lock.json ]; then npm ci; else npm install; fi

test:
  stage: test
  script:
    - echo "Skipping lint and test - not configured yet"

build:
  stage: build
  script:
    - npm run build
  artifacts:
    paths: [dist]
    expire_in: 1 week
  only:
    - branches
    - merge_requests

deploy_prod:
  stage: deploy
  image:
    name: alpine:3.20
    pull_policy: if-not-present   # ← avoid re-pull
  needs: ["build"]
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" $SSH_USER@$SSH_HOST 'echo "SSH OK"'
  script:
    - set -euo pipefail
    - RELEASE="releases/$(date +%Y%m%d%H%M%S)-${CI_COMMIT_SHORT_SHA}"
    - rsync -az --delete dist/ -e "ssh -p $SSH_PORT" "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/$RELEASE/"
    - ssh -p "$SSH_PORT" $SSH_USER@$SSH_HOST "ln -sfn $DEPLOY_PATH/$RELEASE $DEPLOY_PATH/current"
    - ssh -p "$SSH_PORT" $SSH_USER@$SSH_HOST "cd $DEPLOY_PATH/releases && ls -1t | tail -n +8 | xargs -r rm -rf --"
    - ssh -p "$SSH_PORT" $SSH_USER@$SSH_HOST "test -f $DEPLOY_PATH/current/index.html"
  environment:
    name: production
    url: http://my3pai.com
  only:
    - main